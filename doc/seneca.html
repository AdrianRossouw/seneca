<!DOCTYPE html>

<html>
<head>
  <title>seneca.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>seneca.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* Copyright (c) 2010-2014 Richard Rodger, MIT License */</span>
<span class="hljs-comment">/* jshint node:true, asi:true, eqnull:true */</span>
<span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Current version, access using <em>seneca.version</em> property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> VERSION = <span class="hljs-string">'0.5.17'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Node API modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> events   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> net      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'net'</span>)
<span class="hljs-keyword">var</span> repl     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'repl'</span>)
<span class="hljs-keyword">var</span> path     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> buffer   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'buffer'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>External modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _            = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>)
<span class="hljs-keyword">var</span> async        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-keyword">var</span> optimist     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'optimist'</span>)
<span class="hljs-keyword">var</span> nid          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nid'</span>)
<span class="hljs-keyword">var</span> jsonic       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonic'</span>)
<span class="hljs-keyword">var</span> patrun       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'patrun'</span>)
<span class="hljs-keyword">var</span> parambulator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parambulator'</span>)
<span class="hljs-keyword">var</span> norma        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'norma'</span>)
<span class="hljs-keyword">var</span> stats        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rolling-stats'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Internal modules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Entity     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./entity'</span>).Entity
<span class="hljs-keyword">var</span> store      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./store'</span>)
<span class="hljs-keyword">var</span> logging    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./logging'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Utility functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> common   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./common'</span>)
<span class="hljs-keyword">var</span> arrayify = common.arrayify
<span class="hljs-keyword">var</span> noop     = common.noop</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create a new Seneca instance.</p>
<ul>
<li>$     &rarr;  private context</li>
<li>opts  &rarr;  options</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_seneca</span><span class="hljs-params">($, opts)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Seneca is an EventEmitter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Seneca</span><span class="hljs-params">()</span>{</span>
    events.EventEmitter.call(<span class="hljs-keyword">this</span>)
  }
  util.inherits(Seneca, events.EventEmitter)

  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> Seneca()</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Expose the current version of Seneca</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.version = VERSION</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Create a unique identifer for this instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.id = nid()</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3 id="seneca-add">seneca.add</h3>
<p>Add an message pattern and action function.</p>
<p><code>seneca.add( pattern, action )</code>  </p>
<ul>
<li><em>pattern</em> (object or string)  &rarr;  pattern definition</li>
<li><em>action</em> (function)           &rarr;  function executed when input to <code>seneca.act</code> matches pattern</li>
</ul>
<p><code>seneca.add( pattern_string, pattern_object, action )</code>  </p>
<ul>
<li><em>pattern_string</em> (string)  &rarr;  pattern definition as jsonic string  </li>
<li><em>pattern_object</em> (object)  &rarr;  pattern definition as object  </li>
<li><em>action</em> (function)        &rarr;  function executed when input to <code>seneca.act</code> matches pattern.  </li>
</ul>
<p>The pattern is defined by the top level properties of the <em>pattern</em> parameter.
In the case where the pattern is a string, it is first parsed by <a href="https://github.com/rjrodger/jsonic">jsonic</a></p>
<p>If the value of a pattern property is a sub-object, this is interpreted as a 
<a href="https://github.com/rjrodger/parambulator">parambulator</a> validation check. In this case, the property
is not considered part of the pattern, but rather an argument to validate when <em>seneca.act</em> is called.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.add = api_add



  self.logroute   = api_logroute
  self.err        = api_err
  self.register   = api_register
  self.depends    = api_depends
  self.export     = api_export

  self.make       = api_make
  self.make$      = api_make
  self.listen     = api_listen
  self.client     = api_client
  self.cluster    = api_cluster
  self.hasplugin  = api_hasplugin
  self.findplugin = api_findplugin
  self.pin        = api_pin

  self.findact    = api_findact
  self.hasact     = api_hasact
  self.actroutes  = api_actroutes
  self.list       = api_list
  self.act        = api_act
  self.act_if     = api_act_if
  self.wrap       = api_wrap
  self.close      = api_close
  self.ready      = api_ready
  self.use        = api_use
  self.seneca     = api_seneca
  self.fix        = api_fix
  self.delegate   = api_delegate</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Legacy aliases for log option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  opts.log = opts.log || opts.logger || opts.logging || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Option defaults.
<em>deepextend</em> is like underscore.extend, but also traverses sub-objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  opts = deepextend({
    status_interval: <span class="hljs-number">60000</span>,
    stats: {
      size:<span class="hljs-number">1024</span>,
      duration:<span class="hljs-number">60000</span>,
      running:<span class="hljs-literal">false</span>
    },
    listen: {
      host: <span class="hljs-string">'localhost'</span>,
      port: <span class="hljs-number">10101</span>,
      path: <span class="hljs-string">'/act'</span>,
      limit: <span class="hljs-string">'11mb'</span>,
      timeout: <span class="hljs-string">'22222'</span>
    },
    debug:{
      allargs:<span class="hljs-literal">false</span>
    },
    deathdelay:<span class="hljs-number">33333</span>,
    message:MSGMAP,
    test:{
      silent:<span class="hljs-literal">false</span>,
      stayalive:<span class="hljs-literal">false</span>
    }
  },opts)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>legacy api</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( <span class="hljs-string">'print'</span>==opts.log ) {
    opts.log = {map:[{level:<span class="hljs-string">'all'</span>,handler:<span class="hljs-string">'print'</span>}]}
  }



  <span class="hljs-keyword">var</span> argv = optimist.argv


  <span class="hljs-keyword">if</span>( process.env.SENECA_LOG ) {
    opts.log.map = opts.log.map || []
    <span class="hljs-keyword">var</span> loggingconf = process.env.SENECA_LOG
    logging.parse_command_line( loggingconf, opts.log.map )
  }

  <span class="hljs-keyword">if</span>( argv.seneca ) {
    <span class="hljs-keyword">if</span>( argv.seneca.log ) {
      opts.log.map = opts.log.map || []
      logging.parse_command_line( argv.seneca.log, opts.log.map )
    }
  }


  <span class="hljs-keyword">if</span>( !opts.log.map ) {
    opts.log.map = [
      {level:<span class="hljs-string">'info+'</span>,handler:<span class="hljs-string">'print'</span>}
    ]
  }

  
  $.logrouter = logging.makelogrouter(opts.log)

  self.log = logging.makelog($.logrouter)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>setup status log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; opts.status_interval &amp;&amp; opts.status_log ) {
    setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">var</span> stats = {alive:(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()-$.stats.start),act:$.stats.act}
      self.log.info(<span class="hljs-string">'status'</span>,stats)
    },opts.status_interval)
  }

  $.timestats = <span class="hljs-keyword">new</span> stats.NamedStats( opts.stats.size, opts.stats.duration )

  <span class="hljs-keyword">if</span>( opts.stats.running ) {
    setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      $.timestats.calculate()
    }, opts.stats.duration )
  }

  $.plugins    = {}
  $.exports    = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>$.services   = []</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.actrouter = patrun()

  $.plugin_order = {
    byname:[],
    byref:[],
  }


  $.ready_err = <span class="hljs-literal">null</span>
  $.ready_queue = async.queue(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(task,done)</span>{</span>
    <span class="hljs-keyword">if</span>( task.cb ) {
      task.cb.call(self,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>
        <span class="hljs-keyword">if</span>( err ) {
          <span class="hljs-keyword">if</span>( $.ready_err ) {
            $.ready_err.list = $.ready_err.list || []
            $.ready_err.list.push(err)
          }
          <span class="hljs-keyword">else</span> $.ready_err = err;
        }

        done()
      })
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( task.ready ) {
      <span class="hljs-keyword">var</span> err = $.ready_err
      $.ready_err = <span class="hljs-literal">null</span>
      self.log.debug(<span class="hljs-string">'ready'</span>,err)
      task.ready.call(self,err,self)
      self.emit(<span class="hljs-string">'ready'</span>,err,self)
      done()
    }
  },<span class="hljs-number">1</span>)



  self.on(<span class="hljs-string">'error'</span>,noop) <span class="hljs-comment">// prevent process exit</span>



  self.toString   = api_toString


  self.fail = makefail.call(self,{type:<span class="hljs-string">'sys'</span>,plugin:<span class="hljs-string">'seneca'</span>,tag:self.version,id:self.id})</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>say hello, printing identifier to log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( !opts.test.silent ) {
    self.log.info(<span class="hljs-string">'hello'</span>,self.toString())
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>TODO: if no args, return printout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_logroute</span><span class="hljs-params">(entry,handler)</span>{</span>
    entry.handler = handler || entry.handler
    logging.makelogroute(entry,$.logrouter)
  }




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">paramerr</span><span class="hljs-params">(code)</span>{</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span>{</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span> 
        <span class="hljs-keyword">if</span>(err){
          <span class="hljs-keyword">throw</span> self.fail(code,{message:err.message})
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( cb ) { 
          <span class="hljs-keyword">return</span> cb();
        }
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>errfn = required, function; winfn = required, function or boolean, if false, no call</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  function api_err( errfn, winfn ) {
    if( !_.isFunction(errfn) ) throw self.fail({code:'seneca/error_handler_no_err_function'})
    if( !_.isFunction(winfn) &amp;&amp; !_.isBoolean(winfn)) throw self.fail({code:'seneca/error_handler_no_win_function'})
    return function(err) {
      if( err  ) {
        return errfn(err)
      }
      else {
        if( _.isFunction(winfn) ) {
          winfn.apply(null,arrayify(arguments,1))
        }
      }
    }
  }





  var paramcheck = {}

  paramcheck.register = parambulator({
    type$:     'object',
    required$: ['name','init'],
    string$:   ['name'],
    function$: ['init','service'],
    object$:   ['opts']
  },{
    topname:'plugin',
    msgprefix:'register(plugin): ',
    callbackmaker:paramerr('seneca/register_invalid_plugin')
  })


  paramcheck.register = parambulator(
    {type$:'object',required$:['name','init'],string$:['name'],function$:['init','service'],object$:['opts']},
    {topname:'plugin',msgprefix:'register(plugin): ',callbackmaker:paramerr('seneca/register_invalid_plugin')}
  )
  function api_register( plugin, cbfunc ) {
    var self = this

    cbfunc = _.isFunction(cbfunc) ? cbfunc : noop
    paramcheck.register.validate(plugin)

    var fullname = plugin.name+(plugin.tag?'/'+plugin.tag:'')
    var tag      = plugin.tag||'-'
    var nameref  = [plugin.name,tag]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>adjust seneca api to be plugin specific</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> sd = self.delegate()
    sd.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(level)</span> {</span>
      <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)

      args.splice(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-string">'plugin'</span>,plugin.name,tag)
      self.log.apply(self,args)
    }
    logging.makelogfuncs(sd)

    sd.die  = makedie.call(  sd,{type:<span class="hljs-string">'plugin'</span>,plugin:plugin.name})
    sd.fail = makefail.call( sd,{type:<span class="hljs-string">'plugin'</span>,plugin:plugin.name})


    sd.add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)

      <span class="hljs-keyword">var</span> actmeta = args[args.length-<span class="hljs-number">1</span>]
      
      <span class="hljs-keyword">if</span>( _.isFunction(actmeta) ) {
        actmeta = {}
        args.push(actmeta)
      }

      actmeta.plugin_nameref  = nameref
      actmeta.plugin_fullname = fullname
      actmeta.plugin_tag      = tag
      actmeta.log = sd.log

      <span class="hljs-keyword">return</span> self.add.apply(sd,args)
    }

    sd.context = {
      module: plugin.parentmodule || module,
      name:plugin.name,
      tag:plugin.tag,
      full:fullname
    }


    <span class="hljs-keyword">return</span> do_register( plugin.opts )


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_register</span><span class="hljs-params">(opts)</span> {</span>
      self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'init'</span>,fullname)

      opts = opts || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>get options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( <span class="hljs-string">'options'</span> != plugin.name ) {
        self.act({role:<span class="hljs-string">'options'</span>,cmd:<span class="hljs-string">'get'</span>,base:fullname,<span class="hljs-keyword">default</span>$:{}},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,fullname_options)</span>{</span>
          <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> cbfunc(err);

          <span class="hljs-keyword">var</span> shortname = fullname != plugin.name ? plugin.name : <span class="hljs-literal">null</span>
          <span class="hljs-keyword">if</span>( !shortname &amp;&amp; <span class="hljs-number">0</span> === fullname.indexOf(<span class="hljs-string">'seneca-'</span>) ) {
            shortname = fullname.substring(<span class="hljs-string">'seneca-'</span>.length)
          }
        
          <span class="hljs-keyword">if</span>( shortname ) {
            self.act({role:<span class="hljs-string">'options'</span>,cmd:<span class="hljs-string">'get'</span>,base:shortname,<span class="hljs-keyword">default</span>$:{}},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,name_options)</span>{</span>
              <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> cbfunc(err);

              <span class="hljs-keyword">var</span> opts = _.extend({},name_options,fullname_options,plugin.opts||{})
              do_init(opts)
            })
          }
          <span class="hljs-keyword">else</span> do_init( _.extend({},fullname_options,plugin.opts||{}) )
        })
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> do_init(plugin.opts)


      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_init</span><span class="hljs-params">( options )</span> {</span>
        <span class="hljs-keyword">var</span> args = [options,install_plugin]</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>legacy plugins with function(seneca,opts,cb)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( <span class="hljs-number">3</span> == plugin.init.length ){
          args.unshift(sd)
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>single action convenience</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != plugin.init.pattern ) {
          <span class="hljs-keyword">var</span> action = plugin.init
          plugin.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
            <span class="hljs-keyword">this</span>.add(action.pattern,action)
          }
        }
        

        <span class="hljs-keyword">var</span> meta = plugin.init.apply(sd,args)

        meta = (plugin.init.length &lt;= <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> == meta) ? {} : ( meta || {} )
        meta = _.isString( meta ) ? {name:meta} : meta

        <span class="hljs-keyword">return</span> install_plugin(<span class="hljs-literal">null</span>,meta)
      }


      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">install_plugin</span><span class="hljs-params">(err,meta)</span>{</span>
        <span class="hljs-keyword">if</span>( err ) {
          <span class="hljs-keyword">return</span> cbfunc(err);
        }

        meta = meta || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>legacy api for service function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( _.isFunction(meta) ) {
          meta = {service:meta}
        }

        plugin.name    = meta.name    || plugin.name
        plugin.tag     = meta.tag     || plugin.tag || opts.tag$
        plugin.service = meta.service || plugin.service

        nameref[<span class="hljs-number">0</span>]=plugin.name
        nameref[<span class="hljs-number">1</span>]=plugin.tag</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>name may have been changed by return value from plugin init</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> pluginref = plugin.name+(plugin.tag?<span class="hljs-string">'/'</span>+plugin.tag:<span class="hljs-string">''</span>)
        $.plugins[pluginref] = plugin

        $.plugin_order.byname.push(plugin.name)
        $.plugin_order.byname = _.uniq($.plugin_order.byname)

        $.plugin_order.byref.push(pluginref)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>LEGACY</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> service = plugin.service
        <span class="hljs-keyword">if</span>( service ) {
          service.log = sd.log
          service.key = pluginref</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>$.services.push(service)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self.act(<span class="hljs-string">'role:web'</span>,{use:service})
        }


        <span class="hljs-keyword">if</span>( !plugin.declare ) {
          $.ready_queue.push({cb:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span>{</span>
            self.act({init:plugin.name,tag:plugin.tag,<span class="hljs-keyword">default</span>$:{},proxy$:<span class="hljs-literal">false</span>},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span>{</span>
              <span class="hljs-keyword">if</span>( !err ) {
                self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'ready'</span>,pluginref,out)
              }
              done(err)
            })
          }})
        }

        <span class="hljs-keyword">var</span> exports = []
        
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != meta.export ) {
          $.exports[plugin.name] = meta.export
          exports.push(plugin.name)

          $.exports[pluginref] = meta.export
          exports.push(pluginref)
        }

        <span class="hljs-keyword">if</span>( _.isObject(meta.exportmap) || _.isObject(meta.exports) ) {
          meta.exportmap = meta.exportmap || meta.exports
          _.each(meta.exportmap,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span>{</span>
            <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> != v ) {
              <span class="hljs-keyword">var</span> exportname = plugin.name+<span class="hljs-string">'/'</span>+k
              $.exports[exportname] = v
              exports.push(exportname)
            }
          })
        }

        self.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'install'</span>,pluginref,{exports:exports},fullname!=pluginref?fullname:<span class="hljs-literal">undefined</span>)


        cbfunc(<span class="hljs-literal">null</span>)
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>self.depends = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_depends</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{pluginname:s deps:a? moredeps:s*}'</span>,<span class="hljs-built_in">arguments</span>)
    
    <span class="hljs-keyword">var</span> deps = args.deps || args.moredeps

    _.every(deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(depname)</span>{</span>
      <span class="hljs-keyword">if</span>( !_.contains($.plugin_order.byname,depname) &amp;&amp;
          !_.contains($.plugin_order.byname,<span class="hljs-string">'seneca-'</span>+depname) ) {
        self.die(<span class="hljs-string">'plugin_required'</span>,{name:args.pluginname,dependency:depname})
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>self.export = function( key ) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_export</span><span class="hljs-params">( key )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>transitional hack - FIX: create web plugin to handle HTTP end points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( <span class="hljs-string">'web'</span> == key ) {
      <span class="hljs-keyword">return</span> self.service()
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> $.exports[key];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>die
args: code, value*
context: key</p>
<ul>
<li>calls fail:prepare</li>
<li>construct log entry, and issue error log</li>
<li>print user friendly to stderr</li>
<li>calls close<ul>
<li>new actions fail</li>
<li>waits for in-process actions to complete, under timeout</li>
</ul>
</li>
<li>kills process</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Error arguments:
code
code, values
code, Error, values
Error (optional code,message properties), values
values (optional code,message properties)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle_error_args</span><span class="hljs-params">( args, ctxt )</span> {</span>
    args = arrayify(args)

    <span class="hljs-keyword">var</span> first = args[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">var</span> valstart = <span class="hljs-number">1</span>

    <span class="hljs-keyword">var</span> code = <span class="hljs-string">'unknown'</span>
    code = _.isString(first) ? first : code 
    code = util.isError(first) &amp;&amp; _.isString(first.code) ? first.code : code
    code = _.isObject(first) &amp;&amp; _.isString(first.code) ? first.code : code 


    <span class="hljs-keyword">if</span>( _.isObject(first) &amp;&amp; !util.isError(first) ) {
      valstart = <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">var</span> error = util.isError(first) ? first : util.isError(args[<span class="hljs-number">1</span>]) ? (valstart=<span class="hljs-number">2</span>,first) : <span class="hljs-literal">null</span>

    <span class="hljs-keyword">var</span> valmap = _.isObject(args[valstart]) ? args[valstart] : {}

    <span class="hljs-keyword">var</span> message = (opts.message[ctxt.plugin] &amp;&amp; opts.message[ctxt.plugin][code])
    message = _.isString(message) ? message : (_.isString(valmap.message) &amp;&amp; valmap.message)
    message = _.isString(message) ? message : (error &amp;&amp; _.isString(error.message) &amp;&amp; error.message)
    message = _.isString(message) ? message : code</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>workaround to prevent underscore blowing up if properties are not found
reserved words and undefined need to be suffixed with $ in the template interpolates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> valstrmap = {}
    _.each(valmap,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val,key)</span>{</span>
      <span class="hljs-comment">/* jshint evil:true */</span>
      <span class="hljs-keyword">try</span> { <span class="hljs-built_in">eval</span>(<span class="hljs-string">'var '</span>+key+<span class="hljs-string">';'</span>) } <span class="hljs-keyword">catch</span>(e) { key = key+<span class="hljs-string">'$'</span> }
      <span class="hljs-keyword">if</span>( {<span class="hljs-string">'undefined'</span>:<span class="hljs-number">1</span>,<span class="hljs-string">'NaN'</span>:<span class="hljs-number">1</span>}[key] ) { key = key+<span class="hljs-string">'$'</span> }
      valstrmap[key] = (_.isObject(val) ? common.owndesc(val,<span class="hljs-number">1</span>) : <span class="hljs-string">''</span>+val)
    })

    <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">while</span>( !done ) {
      <span class="hljs-keyword">try</span> {
        message = _.template( message, valstrmap )
        done = <span class="hljs-literal">true</span>
      }
      <span class="hljs-keyword">catch</span>(e) {
        <span class="hljs-keyword">if</span>(e <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">ReferenceError</span>) {
          <span class="hljs-keyword">var</span> m = <span class="hljs-regexp">/ReferenceError:\s+(.*?)\s+/</span>.exec(e.toString())
          <span class="hljs-keyword">if</span>( m &amp;&amp; m[<span class="hljs-number">1</span>] ) {
            valstrmap[m[<span class="hljs-number">1</span>]]=<span class="hljs-string">"["</span>+m[<span class="hljs-number">1</span>]+<span class="hljs-string">"?]"</span>
          }
          <span class="hljs-keyword">else</span> done = <span class="hljs-literal">true</span>
        }
        <span class="hljs-keyword">else</span> {
          done = <span class="hljs-literal">true</span>
          message = message+<span class="hljs-string">' VALUES:'</span>+common.owndesc(valmap,<span class="hljs-number">2</span>)
        }
      }
    }

    <span class="hljs-keyword">return</span> {
      code:code,
      error:error,
      message:message,
      remaining:args.slice(valstart),
      valmap:valmap
    }
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makedie</span><span class="hljs-params">( ctxt )</span> {</span>
    <span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">this</span>
    ctxt = _.extend(ctxt,instance.die?instance.die.context:{})

    <span class="hljs-keyword">var</span> die = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

      <span class="hljs-keyword">var</span> args = handle_error_args(<span class="hljs-built_in">arguments</span>,ctxt)

      <span class="hljs-keyword">var</span> code    = args.code
      <span class="hljs-keyword">var</span> error   = args.error
      <span class="hljs-keyword">var</span> message = args.message</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>stayalive is only for testing, do not use in production</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> stayalive = opts.test.stayalive || (error &amp;&amp; error.stayalive)

      <span class="hljs-keyword">if</span>( !error ) {
        error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(code)
      }

      <span class="hljs-keyword">var</span> logargs  = [ctxt.type, ctxt.plugin, ctxt.tag, ctxt.id, code]
            .concat( message &amp;&amp; message != code ? message : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> )
            .concat( args.remaining )</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>TODO: should use self.log here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( !opts.test.silent ) {
        instance.log.fatal.apply( self, logargs )
      }

      <span class="hljs-keyword">var</span> stack = error.stack
      stack = stack.replace(<span class="hljs-regexp">/^.*?\n/</span>,<span class="hljs-string">'\n'</span>)

      <span class="hljs-keyword">var</span> procdesc = process.pid <span class="hljs-comment">// + more</span>

      <span class="hljs-keyword">var</span> stderrmsg =
            <span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Seneca Fatal Error\n"</span>+
            <span class="hljs-string">"==================\n\n"</span>+
            <span class="hljs-string">"Message: "</span>+message+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Code: "</span>+code+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Stack: "</span>+stack+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Instance: "</span>+self.toString()+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"When: "</span>+<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Log: "</span>+common.owndesc(logargs,<span class="hljs-number">3</span>)+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Node: "</span>+util.inspect(process.versions).replace(<span class="hljs-regexp">/\s+/g</span>,<span class="hljs-string">' '</span>)+<span class="hljs-string">"\n\n"</span>+
            <span class="hljs-string">"Process: pid="</span>+procdesc+<span class="hljs-string">", path="</span>+process.execPath+<span class="hljs-string">", args="</span>+util.inspect(process.argv)+<span class="hljs-string">"\n\n"</span>

      <span class="hljs-keyword">if</span>( stayalive ) {
        error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(stderrmsg)
        error.seneca = {
          code:code,
          when:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
          valmap:args.valmap
        }
        <span class="hljs-keyword">throw</span> error
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>this blocks, but that’s ok, we want to be sure the error description is printed to STDERR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( !opts.test.silent ) {
        console.error( stderrmsg )
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>terminate process, err (if defined) is from seneca.close</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">die</span><span class="hljs-params">( err )</span> {</span>
        <span class="hljs-keyword">if</span>( !stayalive ) {
          process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
            <span class="hljs-keyword">if</span>( err ) console.error( err );
            console.error(<span class="hljs-string">"Terminated at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+<span class="hljs-string">".\n\n"</span>)
            process.exit(<span class="hljs-number">1</span>)
          })
        }
      }

      self.close( die )</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>make sure we close down within options.deathdelay seconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( !stayalive ) {
        <span class="hljs-keyword">var</span> killtimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          console.error(<span class="hljs-string">"Terminated (on timeout) at "</span>+(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString())+<span class="hljs-string">".\n\n"</span>)
          process.exit(<span class="hljs-number">2</span>);
        }, opts.deathdelay);
        killtimer.unref();
      }
    }

    die.context = ctxt
    
    <span class="hljs-keyword">return</span> die
  }
  

  self.die = makedie.call(self,{type:<span class="hljs-string">'sys'</span>,plugin:<span class="hljs-string">'seneca'</span>,tag:self.version,id:self.id})




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makefail</span><span class="hljs-params">( ctxt )</span> {</span>
    <span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">this</span>
    ctxt = _.extend(ctxt,instance.fail?instance.fail.context:{})

    <span class="hljs-keyword">var</span> fail = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

      <span class="hljs-keyword">var</span> args = handle_error_args(<span class="hljs-built_in">arguments</span>,ctxt)

      <span class="hljs-keyword">var</span> code    = args.code
      <span class="hljs-keyword">var</span> error   = args.error
      <span class="hljs-keyword">var</span> message = args.message


      message = self.toString()+<span class="hljs-string">': '</span>+message
      message = message.replace(<span class="hljs-regexp">/[\r\n]/g</span>,<span class="hljs-string">' '</span>)

      <span class="hljs-keyword">if</span>( error ) {
        error.message = message
      }
      <span class="hljs-keyword">else</span> {
        error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message)
      }

      error.seneca = {
        code:code,
        when:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
        valmap:args.valmap
      }

      <span class="hljs-comment">/*
      var logargs  = [ctxt.type, ctxt.plugin, ctxt.tag, ctxt.id, code]
            .concat( message &amp;&amp; message != code ? message : void 0 )
            .concat( args.remaining )

      if( !opts.test.silent ) {
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>TODO: should use self.log here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        instance.log.error.apply( self, logargs )
        instance.emit('error',error)
      }
       */

      return error;
    }

    fail.context = ctxt

    return fail
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>all optional
self.make = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_make</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">var</span> si = (<span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.seneca) ? <span class="hljs-keyword">this</span> : self
    args.unshift(si)
    <span class="hljs-keyword">return</span> $.entity.make$.apply($.entity,args)
  }
  self.make$ = self.make</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>self.listen = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_listen</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> config = arrayify(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">if</span>( !self.hasplugin(<span class="hljs-string">'transport'</span> ) ) {
      self.use( <span class="hljs-string">'transport'</span> )
    }

    self.ready(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">throw</span> err;

      self.act(<span class="hljs-string">'role:transport,cmd:listen'</span>,{config:config},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>
        <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;
      })
    })

    <span class="hljs-keyword">return</span> self
  }




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_client</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>self.client = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> config = arrayify(<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> send
    <span class="hljs-keyword">var</span> actq = []
    <span class="hljs-keyword">var</span> client_act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span>{</span>
      actq.push({args:args,done:done})
      process();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span>( send ) {
        <span class="hljs-keyword">var</span> q = actq.slice()
        actq = []
        async.mapLimit(q,<span class="hljs-number">1</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(entry,next)</span>{</span>
          send(entry.args,entry.done)
          next()
        },<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>})
      }
    }

    <span class="hljs-keyword">if</span>( !self.hasplugin(<span class="hljs-string">'transport'</span> ) ) {
      self.use( <span class="hljs-string">'transport'</span> )
    }

    $.ready_queue.push({cb:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(done)</span>{</span>
      self.act(<span class="hljs-string">'role:transport,cmd:client'</span>,{config:config},<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span>{</span>
        <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;

        send = out
        done()

        process()
      })
    }})


    <span class="hljs-keyword">var</span> findact = _.bind(self.findact,self)
    <span class="hljs-keyword">var</span> client = self.delegate()
    client.findact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( args )</span> {</span>
      <span class="hljs-keyword">var</span> actmeta = findact( args )
      <span class="hljs-keyword">if</span>( actmeta &amp;&amp; !args.proxy$ ) <span class="hljs-keyword">return</span> actmeta;

      actmeta = {
        func: client_act,
        plugin_nameref:<span class="hljs-string">'-'</span>,
        log:client.log,
        argpattern:common.owndesc(args),
        id:<span class="hljs-string">'CLIENT'</span>
      }

      <span class="hljs-keyword">return</span> actmeta
    }

    self.proxy$ = client

    <span class="hljs-keyword">return</span> client
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_cluster</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* jshint loopfunc:true */</span>
    <span class="hljs-keyword">var</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cluster'</span>)

    <span class="hljs-keyword">if</span>( cluster.isMaster ) {
      <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).cpus().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
        cluster.fork()
      })

      cluster.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(worker)</span> {</span>
        cluster.fork()
      })

      <span class="hljs-keyword">var</span> noopinstance = self.delegate()
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> fn <span class="hljs-keyword">in</span> noopinstance ) {
        <span class="hljs-keyword">if</span>( _.isFunction(noopinstance[fn]) ) {
          noopinstance[fn] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-keyword">return</span> noopinstance; }
        }
      }

      <span class="hljs-keyword">return</span> noopinstance;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>DEPRECATED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.service = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( service )</span> {</span>
    <span class="hljs-keyword">if</span>( _.isFunction( service ) ) {
      service.log = self.log
      service.key = <span class="hljs-string">'anon-'</span>+nid().substring(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>$.services.push(service)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.act(<span class="hljs-string">'role:web'</span>,{use:service})
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> $.exports.web
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>DEPRECATED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.httprouter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(httproutedeffunc)</span> {</span>
    <span class="hljs-keyword">return</span> httproutedeffunc ? $.exports[<span class="hljs-string">'web/httprouter'</span>](httproutedeffunc) : noopservice
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>DEPRECATED</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.http = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( spec )</span> {</span>
    self.act(<span class="hljs-string">'role:web'</span>,{use:spec})
  }




  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasplugin</span><span class="hljs-params">(plugindesc,tag)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>self.hasplugin = function(plugindesc,tag) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> !!self.findplugin(plugindesc,tag)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>get plugin instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findplugin</span><span class="hljs-params">(plugindesc,tag)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>self.findplugin = function(plugindesc,tag) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> name = plugindesc.name || plugindesc
    tag = plugindesc.tag || tag

    <span class="hljs-keyword">var</span> key = name+(tag?<span class="hljs-string">'/'</span>+tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> plugin = $.plugins[key]

    <span class="hljs-keyword">return</span> plugin
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_pin</span><span class="hljs-params">( pattern, pinopts )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>self.pin = function( pattern, pinopts ) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> thispin = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> methodkeys = []
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> pattern ) {
      <span class="hljs-keyword">if</span>( <span class="hljs-regexp">/[\*\?]/</span>.exec(pattern[key]) ) {
        methodkeys.push(key)
      }
    }


    <span class="hljs-keyword">var</span> methods = $.actrouter.findall(pattern)


    <span class="hljs-keyword">var</span> api = {toString:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span><span class="hljs-keyword">return</span> <span class="hljs-string">'pin:'</span>+descdata(pattern,<span class="hljs-number">1</span>)+<span class="hljs-string">'/'</span>+thispin}}

    methods.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span>{</span>
      <span class="hljs-keyword">var</span> mpat = method.match

      <span class="hljs-keyword">var</span> methodname = <span class="hljs-string">''</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> mkI = <span class="hljs-number">0</span>; mkI &lt; methodkeys.length; mkI++) {
        methodname += ((<span class="hljs-number">0</span>&lt;mkI?<span class="hljs-string">'_'</span>:<span class="hljs-string">''</span>)) + mpat[methodkeys[mkI]]
      }

      api[methodname] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,cb)</span> {</span>
        <span class="hljs-keyword">var</span> si = <span class="hljs-keyword">this</span> &amp;&amp; <span class="hljs-keyword">this</span>.seneca ? <span class="hljs-keyword">this</span> : thispin
        <span class="hljs-keyword">var</span> fullargs = _.extend({},args,mpat)
        si.act.call(si,fullargs,cb)
      }
    })

    <span class="hljs-keyword">if</span>( pinopts ) {
      <span class="hljs-keyword">if</span>( pinopts.include ) {
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; pinopts.include.length; i++ ) {
          <span class="hljs-keyword">var</span> methodname = pinopts.include[i]
          <span class="hljs-keyword">if</span>( thispin[methodname] ) {
            api[methodname] = common.delegate(thispin,thispin[methodname])
          }
        }
      }
    }

    <span class="hljs-keyword">return</span> api
  }


  <span class="hljs-keyword">var</span> pm_custom_args = {
    rules: {
      entity$: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ctxt,cb)</span> {</span>
        <span class="hljs-keyword">var</span> val = ctxt.point
        <span class="hljs-keyword">if</span>( val.entity$ ) {
          <span class="hljs-keyword">if</span>( val.canon$({isa:ctxt.rule.spec}) ) {
            <span class="hljs-keyword">return</span> cb();
          }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> ctxt.util.fail(ctxt,cb);
      }
    },
    msgs: {
      entity$: <span class="hljs-string">'The value &lt;%=value%&gt; is not a data entity of kind &lt;%=rule.spec%&gt; (property &lt;%=parentpath%&gt;).'</span>
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>params: argstr,argobj,actfunc,actmeta
self.add = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_add</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = parse_pattern(self,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'action:f actmeta:o?'</span>)

    <span class="hljs-keyword">var</span> pattern   = args.pattern</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>var paramspec = args.paramspec</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> action    = args.action
    <span class="hljs-keyword">var</span> actmeta   = args.actmeta || {}


    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === _.keys( pattern ) ) {
      <span class="hljs-keyword">throw</span> self.fail({code:<span class="hljs-string">'seneca/no-action-pattern'</span>,args:args})
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>var pm = args.paramspec ? parambulator(args.paramspec) : null
console.dir(pattern)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> pattern_rules = {}
    _.each( pattern, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span>{</span> 
      <span class="hljs-keyword">if</span>( _.isObject(v) ) {
        pattern_rules[k] = v
        <span class="hljs-keyword">delete</span> pattern[k]
      }
    })
    
    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; _.keys(pattern_rules).length ) {
      actmeta.parambulator = parambulator(pattern_rules, pm_custom_args)
    }

    <span class="hljs-keyword">var</span> addroute  = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> priormeta = self.findact( pattern )

    actmeta.args = _.clone( pattern )
    actmeta.argpattern = common.owndesc( pattern )
    actmeta.id = nid()

    actmeta.func = action

    <span class="hljs-keyword">if</span>( priormeta ) {
      <span class="hljs-keyword">if</span>( _.isFunction(priormeta.handle) ) {
        priormeta.handle(action)
        addroute = <span class="hljs-literal">false</span>
      }
      <span class="hljs-keyword">else</span> { 
        actmeta.priormeta = priormeta 
      }
      actmeta.priorpath = priormeta.id+<span class="hljs-string">';'</span>+priormeta.priorpath
    }
    <span class="hljs-keyword">else</span> {
      actmeta.priorpath = <span class="hljs-string">''</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>FIX: need a much better way to support layered actions
this “.handle” hack is just to make seneca.close work</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( action &amp;&amp; actmeta &amp;&amp; _.isFunction(action.handle) ) {
      actmeta.handle = action.handle
    }


    $.stats.actmap[actmeta.argpattern] = 
      $.stats.actmap[actmeta.argpattern] || 
      {id:actmeta.id,
       plugin:{full:actmeta.plugin_fullname,name:actmeta.plugin_nameref,tag:actmeta.plugin_tag},
       prior:actmeta.priorpath,calls:<span class="hljs-number">0</span>,done:<span class="hljs-number">0</span>,fails:<span class="hljs-number">0</span>,time:{}}
    
    <span class="hljs-keyword">if</span>( addroute ) {
      <span class="hljs-keyword">var</span> plugin_name = (actmeta.plugin_nameref &amp;&amp; actmeta.plugin_nameref[<span class="hljs-number">0</span>]) || <span class="hljs-string">'-'</span> 
      <span class="hljs-keyword">var</span> plugin_tag  = (actmeta.plugin_nameref &amp;&amp; actmeta.plugin_nameref[<span class="hljs-number">1</span>]) || <span class="hljs-string">'-'</span> 
      self.log.debug(<span class="hljs-string">'add'</span>,plugin_name,plugin_tag,pattern,actmeta.id)
      $.actrouter.add(pattern,actmeta)
    }

    <span class="hljs-keyword">return</span> self
  }
  


  self.compose = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,acts)</span> {</span>
    self.add(args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(call_args,cb)</span>{</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">call_act</span><span class="hljs-params">(i,cur_args)</span> {</span>
        <span class="hljs-keyword">if</span>( i &lt; acts.length ) {
          cur_args = _.omit(cur_args,_.keys(acts[i-<span class="hljs-number">1</span>]||args))
          cur_args = _.extend(cur_args,acts[i])

          self.act(cur_args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,next_args)</span>{</span>
            <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> cb(err);
            next_args = acts[i].modify$ ? (acts[i].modify$(next_args,call_args)||next_args) : next_args
            call_act(i+<span class="hljs-number">1</span>,next_args)
          })
        }
        <span class="hljs-keyword">else</span> cb(<span class="hljs-literal">null</span>,cur_args)
      }
      call_act(<span class="hljs-number">0</span>,call_args)
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>self.findact = function(args) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_findact</span><span class="hljs-params">(args)</span> {</span>
    <span class="hljs-keyword">var</span> actmeta = $.actrouter.find(args)
    <span class="hljs-keyword">return</span> actmeta
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>self.hasact = function(args) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_hasact</span><span class="hljs-params">(args)</span> {</span>
    <span class="hljs-keyword">return</span> !!$.actrouter.find(args)
  }



  self.findpins = self.pinact = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> pins = []
    <span class="hljs-keyword">var</span> patterns = _.flatten(arrayify(<span class="hljs-built_in">arguments</span>))
    _.each( patterns, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pattern)</span>{</span>
      pattern = _.isString(pattern) ? jsonic(pattern) : pattern
      pins = pins.concat( _.map( $.actrouter.findall(pattern), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(desc)</span> {</span><span class="hljs-keyword">return</span> desc.match} ) )
    })
    <span class="hljs-keyword">return</span> pins
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>self.actroutes = function(){</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_actroutes</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> $.actrouter.toString(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span>{</span>
      <span class="hljs-keyword">var</span> s = <span class="hljs-string">'F='</span>

      <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
        s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
      }

      s+=d.id

      <span class="hljs-keyword">while</span>( d.priormeta ) {
        d = d.priormeta
        s+=<span class="hljs-string">';'</span>

        <span class="hljs-keyword">if</span>( d.plugin_fullname ) {
          s+=d.plugin_fullname+<span class="hljs-string">'/'</span>
        }

        s+=d.id

      }
      <span class="hljs-keyword">return</span> s
    })
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_list</span><span class="hljs-params">( args )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>self.list = function( args ) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> found = $.actrouter.findall( args )
    
    found = _.map( found, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(entry)</span>{</span>
      <span class="hljs-keyword">return</span> entry.match
    })
    <span class="hljs-keyword">return</span> found
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle_act_args</span><span class="hljs-params">(self,orig)</span> {</span>
    <span class="hljs-keyword">var</span> args = parse_pattern( self, orig, <span class="hljs-string">'done:f?'</span> )
    <span class="hljs-keyword">var</span> done = args.done ? args.done : noop

    <span class="hljs-keyword">return</span> [args.pattern,done]
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act_if</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>self.act_if = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">var</span> args = norma(<span class="hljs-string">'{execute:b actargs:.*}'</span>,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">if</span>( args.execute ) {
      <span class="hljs-keyword">return</span> self.act.apply( self, args.actargs )
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> self;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Perform an action. The propeties of the first argument are matched against known patterns, and the most specific one wins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_act</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> argscb = handle_act_args(self,arrayify(<span class="hljs-built_in">arguments</span>))
    <span class="hljs-keyword">var</span> args = argscb[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">var</span> cb   = argscb[<span class="hljs-number">1</span>]

    <span class="hljs-keyword">var</span> actmeta = self.findact(args)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">provide_default</span><span class="hljs-params">()</span> {</span>
      self.log.debug(<span class="hljs-string">'act'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'DEFAULT'</span>,args)
      cb.call(self,<span class="hljs-literal">null</span>,args.default$);
    }

    <span class="hljs-keyword">if</span>( !actmeta ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>if( self.proxy$ &amp;&amp; false !== args.proxy$ &amp;&amp; ((actmeta &amp;&amp; false !== actmeta.proxy)||true) ) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( self.proxy$ &amp;&amp; <span class="hljs-literal">false</span> !== args.proxy$ ) {
        <span class="hljs-keyword">return</span> self.proxy$.act(args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span>{</span>
          <span class="hljs-keyword">if</span>( err &amp;&amp; err.seneca &amp;&amp; <span class="hljs-string">'ECONNREFUSED'</span> == err.seneca.code &amp;&amp; !_.isUndefined(args.default$) ) {
            provide_default()
          }
          <span class="hljs-keyword">else</span> cb(err,out)
        })
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isUndefined(args.default$) ) {
        <span class="hljs-keyword">throw</span> self.fail(<span class="hljs-string">'act_not_found'</span>,{args:args})
      }
      <span class="hljs-keyword">else</span> provide_default()
    }
    <span class="hljs-keyword">else</span> do_act(self,actmeta,<span class="hljs-literal">false</span>,args,cb)

    <span class="hljs-keyword">return</span> self
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_wrap</span><span class="hljs-params">(pin,wrapper)</span> {</span>
    <span class="hljs-keyword">var</span> pinthis = <span class="hljs-keyword">this</span> || self

    <span class="hljs-keyword">if</span>( _.isArray(pin) ) {
      _.each(pin, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span>{</span>
        do_wrap(p)
      })
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> do_wrap(pin);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_wrap</span><span class="hljs-params">( pin )</span> {</span>
      _.each( pinthis.pinact(pin), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(actpattern)</span>{</span>
        pinthis.add(actpattern,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,done)</span>{</span>
          wrapper.call(<span class="hljs-keyword">this</span>,args,done)
        })
      })
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_close</span><span class="hljs-params">(done)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>self.close = function(done){</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'start'</span>)
    self.act(<span class="hljs-string">'role:seneca,cmd:close'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>FIX: needs to be a close action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( $.entity ) {
        $.entity.close$(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(enterr)</span>{</span>
          self.log.debug(<span class="hljs-string">'close'</span>,<span class="hljs-string">'end'</span>,err,enterr)
          <span class="hljs-keyword">if</span>( done ) <span class="hljs-keyword">return</span> done(err||enterr||<span class="hljs-literal">null</span>);
        })
      }
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>self.ready = function(ready) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_ready</span><span class="hljs-params">(ready)</span> {</span>
    <span class="hljs-keyword">if</span>( !_.isFunction(ready) ) <span class="hljs-keyword">return</span>;
    $.ready_queue.push({
      ready:ready
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>use(‘pluginname’) - built-in, or provide calling code ‘require’ as seneca opt
use( require(‘pluginname’) ) - plugin object, init will be called
if first arg has property senecaplugin 
self.use = function( arg0, arg1, arg2 ) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_use</span><span class="hljs-params">( arg0, arg1, arg2 )</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> plugindesc = build_plugindesc( arg0, arg1, arg2 )

    resolve_plugin(plugindesc,self,opts)
    self.register( plugindesc, plugindesc.callback )

    <span class="hljs-keyword">return</span> self
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>self.declare = function( arg0, arg1, arg2 ) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_declare</span><span class="hljs-params">( arg0, arg1, arg2 )</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> plugindesc = build_plugindesc( arg0, arg1, arg2 )
    plugindesc.declare = <span class="hljs-literal">true</span>

    resolve_plugin(plugindesc,self,opts)
    self.register( plugindesc, plugindesc.callback )

    <span class="hljs-keyword">return</span> self
  }


  self.inrepl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    self.on(<span class="hljs-string">'act-out'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arrayify(<span class="hljs-built_in">arguments</span>))
    })
    
    self.on(<span class="hljs-string">'error'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>
      <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>).slice()
      args.unshift(<span class="hljs-string">'ERROR: '</span>)
      logging.handlers.print.apply(<span class="hljs-literal">null</span>,arrayify(args))
    })
  }


  self.startrepl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(in_opts)</span> {</span>
    <span class="hljs-keyword">var</span> repl_opts = _.extend({repl:{listen:<span class="hljs-number">10170</span>}},opts,in_opts)
    
    net.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(socket)</span> {</span>
      <span class="hljs-keyword">var</span> actout =  <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
        socket.write(<span class="hljs-string">''</span>+arrayify(<span class="hljs-built_in">arguments</span>)+<span class="hljs-string">'\n'</span>)
      }
      
      <span class="hljs-keyword">var</span> r = repl.start({
        prompt: <span class="hljs-string">'seneca '</span>+socket.remoteAddress+<span class="hljs-string">':'</span>+socket.remotePort+<span class="hljs-string">'&gt; '</span>, 
        input: socket, output: socket, terminal: <span class="hljs-literal">true</span>, useGlobal: <span class="hljs-literal">false</span>
      })
      
      r.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        self.removeListener(<span class="hljs-string">'act-out'</span>,actout)
        socket.end()
      })
      
      r.context.seneca = self.delegate()
      
      <span class="hljs-keyword">var</span> orig_act = r.context.seneca.act
      r.context.seneca.act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
        args.repl$=<span class="hljs-literal">true</span>
          orig_act.apply(self,args)
        <span class="hljs-keyword">return</span> r.context.seneca
      }

      self.on(<span class="hljs-string">'act-out'</span>,actout)
      
    }).listen(repl_opts.repl.listen)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>/ Return self. Mostly useful as a check that this is a Seneca instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_seneca</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> self
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Describe this instance using the form: Seneca/VERSION/ID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_toString</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>self.toString = function() {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-string">'Seneca/'</span>+self.version+<span class="hljs-string">'/'</span>+self.id
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_act</span><span class="hljs-params">(instance,actmeta,isprior,origargs,cb)</span>{</span>
    <span class="hljs-keyword">var</span> act_start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()

    <span class="hljs-keyword">var</span> args = _.clone(origargs)</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>TODO: doesn’t really work, as requires all sub actions to use ‘this’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> actid = ((instance.fixedargs&amp;&amp;instance.fixedargs.actid)?instance.fixedargs.actid+<span class="hljs-string">'/'</span>:<span class="hljs-string">''</span>)+nid()</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>FIX: make this error nice to handle for calling code - get rid of circular ref</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( actmeta.parambulator ) {
      actmeta.parambulator.validate(args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>

        <span class="hljs-keyword">if</span>( err ) {
          <span class="hljs-keyword">throw</span> instance.fail(<span class="hljs-string">'invalid-act-args'</span>,{message:err.message})
        }

        <span class="hljs-keyword">return</span> perform(actmeta)
      })
    } 
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> perform(actmeta);


    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">perform</span><span class="hljs-params">(actmeta)</span> {</span>
      <span class="hljs-keyword">var</span> actstats = ($.stats.actmap[actmeta.argpattern] = $.stats.actmap[actmeta.argpattern] || {})

      <span class="hljs-keyword">var</span> plugin_nameref = actmeta.plugin_nameref||[<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>]

      self.log.debug(<span class="hljs-string">'act'</span>,plugin_nameref[<span class="hljs-number">0</span>]||<span class="hljs-string">'-'</span>,plugin_nameref[<span class="hljs-number">1</span>]||<span class="hljs-string">'-'</span>,actid,<span class="hljs-string">'IN'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
        <span class="hljs-keyword">return</span> [actmeta.descdata ? actmeta.descdata(args) : descdata(args), actmeta.id]
      })
      
      <span class="hljs-keyword">var</span> delegate = instance.delegate({actid$:actid})


      <span class="hljs-keyword">try</span> {
        instance.emit(<span class="hljs-string">'act-in'</span>, actmeta.argpattern, actid, args)</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>automate actid log insertion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        delegate.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
          <span class="hljs-keyword">if</span>( _.isFunction(actmeta.log) ) {
            <span class="hljs-keyword">var</span> entries = [args[<span class="hljs-number">0</span>]].concat(actid).concat(args.slice(<span class="hljs-number">1</span>))
            actmeta.log.apply(instance,entries)
          }
          <span class="hljs-keyword">else</span> {
            instance.log.apply(instance,[args[<span class="hljs-number">0</span>]].concat([<span class="hljs-string">'single'</span>,<span class="hljs-string">'-'</span>,<span class="hljs-string">'-'</span>,actid]).concat(args.slice(<span class="hljs-number">1</span>)))
          }
        }
        logging.makelogfuncs(delegate)


        <span class="hljs-keyword">if</span>( actmeta.priormeta ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>TODO: deprecate parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          delegate.prior = delegate.parent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,cb)</span> {</span>
            do_act(delegate,actmeta.priormeta,<span class="hljs-literal">true</span>,args,cb)
          }
        }
        <span class="hljs-keyword">else</span> delegate.prior = nil


        <span class="hljs-keyword">var</span> callargs = args</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>fixed args are not used for finding actions!!!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( delegate.fixedargs ) {
          callargs = _.extend({},args,delegate.fixedargs)
        }
        
        $.stats.act.calls++
        actstats.calls++
        <span class="hljs-keyword">var</span> actstart = <span class="hljs-built_in">Date</span>.now()



        delegate.good = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(out)</span> {</span>
          act_done(<span class="hljs-literal">null</span>,out)
        }

        delegate.bad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
          act_done(err)
        }



        <span class="hljs-keyword">var</span> act_done = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
          <span class="hljs-keyword">var</span> actend = <span class="hljs-built_in">Date</span>.now()
          $.timestats.point( actend-actstart, actmeta.argpattern )

          <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)

          <span class="hljs-keyword">if</span>( err ) {
            $.stats.act.fails++
            actstats.fails++
            instance.log.error(<span class="hljs-string">'act'</span>,<span class="hljs-string">'err'</span>,actid,err.message,stackfirst(err) )
          }
          <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> emitargs = args.slice()
            emitargs.unshift(actid)
            emitargs.unshift(actmeta.argpattern)
            emitargs.unshift(<span class="hljs-string">'act-out'</span>)
            instance.emit.apply(instance,emitargs)
            
            args[<span class="hljs-number">0</span>] = <span class="hljs-literal">null</span>

            self.log.debug(<span class="hljs-string">'act'</span>,plugin_nameref[<span class="hljs-number">0</span>]||<span class="hljs-string">'-'</span>,plugin_nameref[<span class="hljs-number">1</span>]||<span class="hljs-string">'-'</span>,actid,<span class="hljs-string">'OUT'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
              <span class="hljs-keyword">return</span> _.flatten( [ _.flatten([ actmeta.descdata ? actmeta.descdata(args.slice(<span class="hljs-number">1</span>)) : descdata(args.slice(<span class="hljs-number">1</span>)) ], <span class="hljs-literal">true</span>), actmeta.id ] )
            })

            $.stats.act.done++
            actstats.done++
          }
          
          <span class="hljs-keyword">try</span> {
            cb.apply(delegate,args) <span class="hljs-comment">// note: err == args[0]</span>
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>for errors thrown inside the callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">catch</span>( er ) {
            <span class="hljs-keyword">var</span> error = er
            <span class="hljs-keyword">if</span>( error.seneca ) {
              error.seneca.callback = <span class="hljs-literal">true</span>
              <span class="hljs-keyword">throw</span> error;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>handle throws of non-Error values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>( !util.isError(error) ) {
              <span class="hljs-keyword">if</span>( _.isObject(error) ) {
                error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(common.owndesc(error,<span class="hljs-number">1</span>))
              }
              <span class="hljs-keyword">else</span> {
                error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">''</span>+error)
              }
            }

            <span class="hljs-keyword">var</span> err = instance.fail( error, {args:args} )

            <span class="hljs-keyword">if</span>( !opts.test.silent) {
              self.log.error(<span class="hljs-string">'act'</span>,<span class="hljs-string">'err'</span>,actid, <span class="hljs-string">'callback'</span>, err.message, actmeta.id, stackfirst(error) )
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>mark this as an exception from a callback
to be rethrown by seneca.act - not much point sending it back to the callback that created it! </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            err.seneca.callback = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">throw</span> err;
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>FIX: needs a timeout!!!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        actmeta.func.call(delegate,callargs,act_done)
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>for errors inside the action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">catch</span>( er ) {
        <span class="hljs-keyword">var</span> ex = er

        <span class="hljs-keyword">if</span>( ex.seneca &amp;&amp; ex.seneca.callback ) {
          <span class="hljs-keyword">throw</span> ex
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>handle throws of non-Error values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( !util.isError(ex) ) {
          <span class="hljs-keyword">if</span>( _.isObject(ex) ) {
            ex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(common.owndesc(ex,<span class="hljs-number">1</span>))
          }
          <span class="hljs-keyword">else</span> {
            ex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">''</span>+ex)
          }
        }

        <span class="hljs-keyword">var</span> err = ex
        <span class="hljs-keyword">if</span>( !ex.seneca ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>FIX: use new error code format
sent to callback as inside action
err = instance.fail( descerror({code:’seneca/act_error’,args:args},ex))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          err = instance.fail( ex, {args:args} )
        }

        <span class="hljs-keyword">var</span> actend = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()

        $.stats.act.fails++
        actstats.fails++

        <span class="hljs-keyword">if</span>( !opts.test.silent) {
          self.log.error(<span class="hljs-string">'act'</span>,<span class="hljs-string">'err'</span>,actid, ex.message, actmeta.id, stackfirst(ex) )
        }

        cb.call( delegate, err )
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>loop over a list of items recursively
list can be an integer - number of times to recurse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recurse</span><span class="hljs-params">(list,work,done)</span> {</span>
    <span class="hljs-comment">/* jshint validthis:true */</span>

    <span class="hljs-keyword">var</span> ctxt = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">if</span>( _.isNumber(list) ) {
      <span class="hljs-keyword">var</span> size = list
      list = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(size)
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; size; i++){
        list[i]=i
      }
    }
    <span class="hljs-keyword">else</span> {
      list = _.clone(list)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">(err,out)</span>{</span>
      <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> done(err,out);

      <span class="hljs-keyword">var</span> item = list.shift()

      <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> !== item ) {
        work.call(ctxt,item,next)
      }
      <span class="hljs-keyword">else</span> {
        done.call(ctxt,err,out)
      }
    }
    next.call(ctxt)
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepextend</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
    args.unshift([])
    <span class="hljs-keyword">return</span> deepextend_impl.apply( <span class="hljs-literal">null</span>, args )
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>TODO: can still fail if objects are too deeply complex - need a finite bound on recursion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deepextend_impl</span><span class="hljs-params">(seen, tar)</span> {</span>
    <span class="hljs-comment">/* jshint loopfunc:true */</span>

    tar = _.clone(tar)
    _.each(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(src)</span> {</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> src) {
        <span class="hljs-keyword">var</span> v = src[p]
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> !== v ) {

          <span class="hljs-keyword">if</span>( _.isString(v) || _.isNumber(v) || _.isBoolean(v) || _.isDate(v) || _.isFunction(v) || _.isRegExp(v) ) {
            tar[p] = v
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>this also works for arrays - allows index-specific overrides if object used - see test/common-test.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isObject(v) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>don’t descend into..</p>

            </div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>entities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>( v.entity$ ) {
              tar[p] = v
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>circulars</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.contains( seen, v ) ) {
              tar[p] = v
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>objects with methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.find(v,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span>{</span><span class="hljs-keyword">return</span> _.isFunction(f)}) ) {
              tar[p] = v
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>else it’s just a pure data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {
              seen.push(v)
              tar[p] = _.isObject( tar[p] ) ? tar[p] : (_.isArray(v) ? [] : {})</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>for array/object mismatch, override completely</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span>( (_.isArray(v) &amp;&amp; !_.isArray( tar[p] ) ) || (!_.isArray(v) &amp;&amp; _.isArray( tar[p] ) ) ) {
                tar[p] = src[p]
              }
            
              tar[p] = deepextend_impl( seen, tar[p], src[p] )
            }
          }
          <span class="hljs-keyword">else</span> {
            tar[p] = v
          }
        }
      }
    })
    <span class="hljs-keyword">return</span> tar
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>remove any props containing $</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clean</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == obj ) <span class="hljs-keyword">return</span> obj;

    <span class="hljs-keyword">var</span> out = {}
    <span class="hljs-keyword">if</span>( obj ) {
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> obj ) {
        <span class="hljs-keyword">if</span>( !~p.indexOf(<span class="hljs-string">'$'</span>) ) {
          out[p] = obj[p]
        }
      }
    }
    <span class="hljs-keyword">return</span> out
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>noop for callbacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nil</span><span class="hljs-params">()</span>{</span>
    _.each(<span class="hljs-built_in">arguments</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg)</span>{</span>
      <span class="hljs-keyword">if</span>( _.isFunction(arg) ) {
        <span class="hljs-keyword">return</span> arg()
      }
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>use args properties as fields
defaults: map of default values
args: args object
fixed: map of fixed values - cannot be overriden
omits: array of prop names to exclude
defaults, args, and fixed are deepextended together in that order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">argprops</span><span class="hljs-params">( defaults, args, fixed, omits)</span>{</span>
    omits = _.isArray(omits) ? omits : _.isObject(omits) ? _.keys(omits) : _.isString(omits) ? omits.split(<span class="hljs-regexp">/\s*,\s*/</span>) : <span class="hljs-string">''</span>+omits</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>a little pre omit to avoid entities named in omits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> usedargs = _.omit( args, omits )</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>don’t support $ args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    usedargs = clean(usedargs)

    <span class="hljs-keyword">return</span> _.omit( deepextend( defaults, usedargs, fixed ), omits )
  }



  self.util = {
    deepextend: deepextend,
    recurse: recurse,
    clean: clean,
    copydata: common.copydata,
    router: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-keyword">return</span> patrun() },
    parsecanon: Entity.parsecanon,
    nil: nil,
    argprops: argprops,

    print: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span>{</span>
      <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;

      console.log(util.inspect(out,{depth:<span class="hljs-literal">null</span>}))
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">2</span>; <span class="hljs-number">2</span> &lt; <span class="hljs-built_in">arguments</span>.length; i++) {
        console.dir(<span class="hljs-built_in">arguments</span>[i])
      }
    }
  }


  self.store = {
    init: store.init,
    cmds: store.cmds
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>string args override object args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse_pattern</span><span class="hljs-params">(instance,args,normaspec,fixed)</span> {</span>
    args = norma(<span class="hljs-string">'{strargs:s? objargs:o? '</span>+(normaspec||<span class="hljs-string">''</span>)+<span class="hljs-string">'}'</span>, args)

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> _.extend(
        args,
        { pattern: _.extend(
          args.objargs ? args.objargs : {},
          args.strargs ? jsonic( args.strargs ) : {},
          fixed || {} )
        })
    }
    <span class="hljs-keyword">catch</span>( e ) {
      <span class="hljs-keyword">var</span> col = <span class="hljs-number">1</span>==e.line?e.column-<span class="hljs-number">1</span>:e.column
      <span class="hljs-keyword">throw</span> instance.fail(<span class="hljs-string">'add_string_pattern_syntax'</span>,{argstr:args,syntax:e.message,line:e.line,col:col})</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>throw instance.fail({code:’seneca/string-pattern-syntax-error’,args:args})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_fix</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> defargs = parse_pattern(self,<span class="hljs-built_in">arguments</span>)

    <span class="hljs-keyword">var</span> fix = self.delegate( defargs.pattern )

    fix.add = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> args    = parse_pattern(fix,<span class="hljs-built_in">arguments</span>,<span class="hljs-string">'rest:.*'</span>,defargs.pattern)
      <span class="hljs-keyword">var</span> addargs = [args.pattern].concat(args.rest)
      <span class="hljs-keyword">return</span> self.add.apply(fix,addargs)
    }
    
    <span class="hljs-keyword">return</span> fix
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>self.delegate = function(fixedargs) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api_delegate</span><span class="hljs-params">(fixedargs)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> delegate = <span class="hljs-built_in">Object</span>.create(self)
    <span class="hljs-keyword">var</span> act = delegate.act

    delegate.act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">var</span> argscb = handle_act_args(<span class="hljs-keyword">this</span>,arrayify(<span class="hljs-built_in">arguments</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>can’t override fixedargs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> args = _.extend({},argscb[<span class="hljs-number">0</span>],fixedargs)

      <span class="hljs-keyword">var</span> cb = argscb[<span class="hljs-number">1</span>]

      act.call(<span class="hljs-keyword">this</span>,args,cb)

      <span class="hljs-keyword">return</span> delegate
    }

    <span class="hljs-keyword">var</span> strdesc
    delegate.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">if</span>( strdesc ) <span class="hljs-keyword">return</span> strdesc;
      <span class="hljs-keyword">var</span> vfa = {}
      _.each(fixedargs,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v,k)</span>{</span>
        <span class="hljs-keyword">if</span>( ~k.indexOf(<span class="hljs-string">'$'</span>) ) <span class="hljs-keyword">return</span>;
        vfa[k]=v
      })

      strdesc = self.toString()+(_.keys(vfa).length?<span class="hljs-string">'/'</span>+common.owndesc(vfa,<span class="hljs-number">0</span>,<span class="hljs-literal">false</span>):<span class="hljs-string">''</span>)

      <span class="hljs-keyword">return</span> strdesc
    }
    
    delegate.delegate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(further_fixedargs)</span> {</span>
      <span class="hljs-keyword">var</span> args = _.extend({},further_fixedargs||{},fixedargs)
      <span class="hljs-keyword">return</span> self.delegate.call(<span class="hljs-keyword">this</span>,args)
    }

    delegate.fixedargs = fixedargs

    <span class="hljs-keyword">return</span> delegate
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>for use with async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.next_act = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> si   = <span class="hljs-keyword">this</span> || self
    <span class="hljs-keyword">var</span> args = arrayify(<span class="hljs-built_in">arguments</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(next)</span>{</span>
      args.push(next)
      si.act.apply(si,args)
    }
  }



  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">descdata</span><span class="hljs-params">(data,depth)</span> {</span>
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, cleandata

    depth = depth || <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span>( <span class="hljs-number">3</span> &lt; depth ) <span class="hljs-keyword">return</span> _.isArray(data) ? <span class="hljs-string">'[-]'</span> : _.isObject(data) ? <span class="hljs-string">'{-}'</span> : <span class="hljs-string">''</span>+data;

    <span class="hljs-keyword">if</span>( !_.isObject(data) ) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>+data
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isArray(data) ) {
      cleandata = []
      <span class="hljs-keyword">for</span>( i = <span class="hljs-number">0</span>; i &lt; data.length &amp;&amp; i &lt; <span class="hljs-number">3</span>; i++ ) {
        cleandata.push(descdata(data[i]))
      }

      <span class="hljs-keyword">if</span>( i &lt; data.length ) {
        cleandata.push(<span class="hljs-string">' ...(len='</span>+data.length+<span class="hljs-string">')'</span>)
      }

      <span class="hljs-keyword">return</span> cleandata
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isDate(data) ) {
      <span class="hljs-keyword">return</span> data.toISOString()
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isObject(data) &amp;&amp; data.entity$ ) {
      <span class="hljs-keyword">return</span> data.toString()
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span>( data.seneca &amp;&amp; data.seneca.nodesc ) <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;SENECA&gt;'</span>;
      cleandata = {}
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> data ) {
        <span class="hljs-keyword">if</span>( <span class="hljs-number">16</span> &lt; i++ ) {
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span>( data.hasOwnProperty(p) &amp;&amp; 
            (!~p.indexOf(<span class="hljs-string">'$'</span>) || opts.debug.allargs ) &amp;&amp; 
            !_.isFunction(data[p]) ) {
          cleandata[p] = descdata(data[p],<span class="hljs-number">1</span>+depth)
        }
      }
      <span class="hljs-keyword">if</span>( <span class="hljs-number">16</span> &lt; i ) {
        cleandata[<span class="hljs-string">'&lt;LEN&gt;'</span>]=i
      }

      <span class="hljs-keyword">return</span> cleandata
    }
  }

  <span class="hljs-keyword">return</span> self
}







<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">(opts)</span> {</span>
  opts = opts || {}</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>private context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> $ = {
    stats:{
      start:<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),
      act:{calls:<span class="hljs-number">0</span>,done:<span class="hljs-number">0</span>,fails:<span class="hljs-number">0</span>},
      actmap:{}
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>create instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> seneca = make_seneca($,opts)</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>set default commands</p>

            </div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>FIX: such a hack!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> closehandler_functions = []
  <span class="hljs-keyword">var</span> closehandler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args,cb)</span>{</span>
    <span class="hljs-keyword">var</span> instance = <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">var</span> errs = []
    <span class="hljs-keyword">var</span> outs = []
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span><span class="hljs-params">(i)</span> {</span>
      <span class="hljs-keyword">if</span>( i &lt; closehandler_functions.length ) {
        closehandler_functions[i].call(instance,args,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,out)</span>{</span>
          <span class="hljs-keyword">if</span>( err ) errs.push(err);
          outs.push(out)
          next(i+<span class="hljs-number">1</span>)
        })
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> lasterr = <span class="hljs-number">0</span> &lt; errs.length ? errs[errs.length-<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>
        <span class="hljs-keyword">var</span> lastout = <span class="hljs-number">0</span> &lt; outs.length ? outs[outs.length-<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>
        cb.call(instance,lasterr,lastout)
      }
    }
    next(<span class="hljs-number">0</span>,<span class="hljs-literal">null</span>,[])
  }

  closehandler.handle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f)</span> {</span>
    closehandler_functions.push(f)
  }

  seneca.add({role:<span class="hljs-string">'seneca'</span>,cmd:<span class="hljs-string">'close'</span>},closehandler)


  seneca.add({role:<span class="hljs-string">'seneca'</span>,stats:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( args, done )</span> {</span>
    <span class="hljs-keyword">var</span> stats
    <span class="hljs-keyword">if</span>( args.pattern &amp;&amp; $.stats.actmap[args.pattern] ) {
      stats = $.stats.actmap[args.pattern]
      stats.time = $.timestats.calculate(args.pattern)
    }
    <span class="hljs-keyword">else</span> {
      stats = _.clone($.stats)
      stats.now    = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      stats.uptime = stats.now - stats.start

      stats.now   = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.now).toISOString()
      stats.start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(stats.start).toISOString()

      <span class="hljs-keyword">var</span> summary = (<span class="hljs-literal">null</span> == args.summary &amp;&amp; <span class="hljs-literal">false</span>) || (<span class="hljs-regexp">/^false$/i</span>.exec(args.summary) ? <span class="hljs-literal">false</span> : !!(args.summary) )
      <span class="hljs-keyword">if</span>( summary ) {
        stats.actmap = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
      }
      <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>_.each( $.timestats.calculate(), function(t,p) { 
 $.stats.actmap[p].time = t
})</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _.each( $.stats.actmap, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,p)</span>{</span> $.stats.actmap[p].time = $.timestats.calculate(p) })
      }
    }

    done(<span class="hljs-literal">null</span>,stats)
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>register default plugins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  seneca.use(<span class="hljs-string">'util'</span>)
  seneca.use(<span class="hljs-string">'web'</span>)
  seneca.use(<span class="hljs-string">'mem-store'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>register options plugins</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(opts.plugins, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(plugindesc)</span>{</span>
    seneca.use(plugindesc)
  })</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>setup delegate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sd = seneca.delegate()
  sd.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = [<span class="hljs-string">'entity'</span>]
    seneca.log.apply(seneca,args.concat(arrayify(<span class="hljs-built_in">arguments</span>)))
  }
  logging.makelogfuncs(sd)
  
  $.entity = <span class="hljs-keyword">new</span> Entity({},sd)

  <span class="hljs-keyword">return</span> seneca
}




init.loghandler = logging.handlers</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>makes require(‘seneca’).use( … ) work by creating an on-the-fly instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>init.use = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> instance = init()
  <span class="hljs-keyword">return</span> instance.use.apply(instance,arrayify(<span class="hljs-built_in">arguments</span>))
}


module.exports = init</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>A middleware service that does nothing. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noopservice</span><span class="hljs-params">( req, res, next )</span> {</span>
  <span class="hljs-keyword">if</span>( next ) <span class="hljs-keyword">return</span> next();
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stackfirst</span><span class="hljs-params">( error )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>return ( error &amp;&amp; error.stack &amp;&amp; (error.stack+’ \n ‘).split(‘\n’)[1] ) || ‘’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> out = <span class="hljs-string">''</span>
  <span class="hljs-keyword">if</span>( error &amp;&amp; error.stack ) {
    <span class="hljs-keyword">var</span> lines = error.stack.split(<span class="hljs-string">'\n'</span>)
    <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; lines.length; i++ ) {
      <span class="hljs-keyword">var</span> line = lines[i]

      done = (
        !line.match(<span class="hljs-regexp">/\/seneca.js/</span>) &amp;&amp;
        !line.match(<span class="hljs-regexp">/\/norma.js/</span>)
      )

      <span class="hljs-keyword">if</span>( done ) {
        <span class="hljs-keyword">return</span> line;
      }
    }
  }

  <span class="hljs-keyword">return</span> out
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safe_json_stringify</span><span class="hljs-params">(obj,depth)</span> {</span>
  depth = depth || <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> jsonstr = <span class="hljs-string">''</span>
  <span class="hljs-keyword">try</span> {
    jsonstr = <span class="hljs-built_in">JSON</span>.stringify(obj)
  }
  <span class="hljs-keyword">catch</span>( e ) {
    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span>&lt;depth &amp;&amp; ~e.message.indexOf(<span class="hljs-string">"circular structure"</span>) ) {
      jsonstr = <span class="hljs-string">"[Circular...]"</span>
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> sb = []
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> obj ) {
        sb.push(k+<span class="hljs-string">'='</span>+safe_json_stringify(obj[k],depth+<span class="hljs-number">1</span>))
      }
      jsonstr = <span class="hljs-string">'&lt;'</span>+sb.join(<span class="hljs-string">','</span>)+<span class="hljs-string">'&gt;'</span>
    }
  }
  <span class="hljs-keyword">return</span> jsonstr
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build_plugindesc</span><span class="hljs-params">( arg0, arg1, arg2 )</span> {</span>
  <span class="hljs-keyword">var</span> parentmodule = module.parent
  <span class="hljs-keyword">var</span> plugin = arg0 ? (arg0.senecaplugin || arg0) : <span class="hljs-literal">null</span>

  <span class="hljs-keyword">var</span> plugin_opts = (_.isObject(arg1) || _.isString(arg1) || _.isNumber(arg1) || _.isBoolean(arg1) ) &amp;&amp; 
        !_.isFunction(arg1) ? arg1 : {}
  <span class="hljs-keyword">var</span> cb = _.isFunction(arg2) ? arg2 : (_.isFunction(arg1) ? arg1 : <span class="hljs-literal">null</span>) 

  plugin_opts = _.isString(arg1) || _.isNumber(arg1) || _.isBoolean(arg1) ? {value$:plugin_opts} : plugin_opts

  <span class="hljs-keyword">var</span> plugindesc = {opts:plugin_opts,callback:cb}

  <span class="hljs-keyword">if</span>( _.isString(plugin) ) {
    plugindesc.name = plugin
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isFunction( plugin ) ) {
    plugindesc.name = plugin.name || plugin.seneca_name || <span class="hljs-string">'anon-'</span>+nid()
    plugindesc.init = plugin
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( _.isObject( plugin ) ) {
    plugindesc = plugin
  }
  
  plugindesc.opts = _.extend(plugindesc.opts||{},plugin_opts||{})

  plugindesc.parentmodule = parentmodule

  <span class="hljs-keyword">return</span> plugindesc
}</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>finds the plugin module using require
the module must be a function
sets plugindesc.init to be the function exposed by the module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve_plugin</span><span class="hljs-params">( plugindesc, seneca, opts )</span> {</span>
  seneca.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'resolve'</span>,common.owndesc(plugindesc,<span class="hljs-number">1</span>))

  <span class="hljs-keyword">var</span> use_require = opts.require || plugindesc.parentmodule.require || <span class="hljs-built_in">require</span>


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">try_require</span><span class="hljs-params">(name)</span> {</span>
    <span class="hljs-keyword">var</span> first_err = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">var</span> found

    <span class="hljs-keyword">if</span>( !name ) <span class="hljs-keyword">return</span> found;

    <span class="hljs-keyword">try</span> {
      plugindesc.searched_paths.push(name)
      found = use_require(name)
      <span class="hljs-keyword">return</span> found
    }
    <span class="hljs-keyword">catch</span>(e) {
      first_err = first_err || e</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>also try seneca module dependencies, e.g. seneca-web</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">try</span> {
        found = <span class="hljs-built_in">require</span>(name)
      }
      <span class="hljs-keyword">catch</span>(ee) {
        first_err = first_err || ee
      }

      <span class="hljs-keyword">return</span> found;
    }
  }


  <span class="hljs-keyword">if</span>( !plugindesc.name ) {
    <span class="hljs-keyword">return</span> seneca.die(<span class="hljs-string">'plugin_no_name'</span>,plugindesc)
  }


  <span class="hljs-keyword">var</span> m = <span class="hljs-regexp">/^(.+)|(.+)$/</span>.exec(plugindesc.name)
  <span class="hljs-keyword">if</span>( m ) {
    plugindesc.name = m[<span class="hljs-number">1</span>]
    plugindesc.tag  = m[<span class="hljs-number">2</span>]
  }

  <span class="hljs-keyword">if</span>( !plugindesc.init) {
    plugindesc.searched_paths = []
    <span class="hljs-keyword">var</span> name = plugindesc.name
    <span class="hljs-keyword">var</span> tag  = plugindesc.tag
    <span class="hljs-keyword">var</span> fullname = name+(tag?<span class="hljs-string">'/'</span>+tag:<span class="hljs-string">''</span>)
    <span class="hljs-keyword">var</span> initfunc</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>try to load as a built-in module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span>( ~name.indexOf(<span class="hljs-string">'..'</span>) || ~name.indexOf(<span class="hljs-string">'/'</span>) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>yes, control flow. I will burn in Hell.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"not a built-in: '"</span>+name+<span class="hljs-string">"', [SKIP]"</span>)
      }

      <span class="hljs-keyword">var</span> builtin_path = <span class="hljs-string">'../plugin/'</span>+name
      plugindesc.searched_paths.push(builtin_path)
      seneca.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'require'</span>,builtin_path,fullname)
      initfunc = <span class="hljs-built_in">require</span>(builtin_path)
    }

    <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">if</span>( e.message &amp;&amp; ( -<span class="hljs-number">1</span> != e.message.indexOf(<span class="hljs-string">"'"</span>+builtin_path+<span class="hljs-string">"'"</span>) || ~e.message.indexOf(<span class="hljs-string">'[SKIP]'</span>)) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>try to load as a seneca repo module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        seneca.log.debug(<span class="hljs-string">'register'</span>,<span class="hljs-string">'require'</span>,fullname)

        <span class="hljs-keyword">var</span> plugin_names = [name,<span class="hljs-string">'seneca-'</span>+name,<span class="hljs-string">'./'</span>+name]
        <span class="hljs-keyword">var</span> parent_filename = (plugindesc.parentmodule||{}).filename
        <span class="hljs-keyword">var</span> paths = parent_filename ? [ path.dirname(parent_filename) ] : [] 
        paths = _.compact(paths.concat((plugindesc.parentmodule||{}).paths||[]))

        <span class="hljs-keyword">var</span> plugin_paths = plugin_names.slice()
        paths.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span>{</span>
          plugin_names.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
            plugin_paths.push(path+<span class="hljs-string">'/'</span>+name)
          })
        })

        <span class="hljs-keyword">var</span> first_err
        <span class="hljs-keyword">do</span> {
          <span class="hljs-keyword">var</span> plugin_path = plugin_paths.shift()
          initfunc = try_require(plugin_path)
        }
        <span class="hljs-keyword">while</span>( _.isUndefined(initfunc) &amp;&amp; <span class="hljs-number">0</span> &lt; plugin_paths.length )
        <span class="hljs-keyword">if</span>( first_err ) <span class="hljs-keyword">throw</span> first_err;

      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> e;
    }


    <span class="hljs-keyword">if</span>( initfunc ) {
      <span class="hljs-keyword">if</span>( !_.isFunction(initfunc) ) {
        seneca.die(<span class="hljs-string">'plugin_bad_init'</span>,plugindesc)
      }

      plugindesc.init = initfunc
    }
    <span class="hljs-keyword">else</span> {
      seneca.die(<span class="hljs-string">'plugin_not_found'</span>,plugindesc)
    }
  }
}



<span class="hljs-keyword">var</span> MSGMAP = {
  seneca:{
    test_prop: <span class="hljs-string">'TESTING: exists: &lt;%=exists%&gt;, notfound:&lt;%=notfound%&gt;, str=&lt;%=str%&gt;, obj=&lt;%=obj%&gt;, arr=&lt;%=arr%&gt;, bool=&lt;%=bool%&gt;, null=&lt;%=null$%&gt;, delete=&lt;%=delete$%&gt;, undefined=&lt;%=undefined$%&gt;, void=&lt;%=void$%&gt;, NaN=&lt;%=NaN$%&gt;'</span>,

    plugin_required:   <span class="hljs-string">'Plugin "&lt;%=name%&gt;" depends on plugin "&lt;%=dependency%&gt;", which is not yet loaded.'</span>,
    plugin_bad_init:   <span class="hljs-string">'Plugin "&lt;%=name%&gt;" definition should be an initialisation function.'</span>,
    plugin_not_found:  <span class="hljs-string">'Plugin "&lt;%=name%&gt;" could not be found.'</span>,
    plugin_no_name:    <span class="hljs-string">'Plugin does not have a name.'</span>,

    add_string_pattern_syntax: <span class="hljs-string">'Could not add action due to syntax error in pattern string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,
    act_string_args_syntax: <span class="hljs-string">'Could execute action due to syntax error in argument string: "&lt;%=argstr%&gt;": Line:&lt;%=line%&gt;, Column:&lt;%=col%&gt;; &lt;%=syntax%&gt;'</span>,

    add_pattern_object_expected_after_string_pattern: <span class="hljs-string">'Could not add action; unexpected argument; a pattern object or function should follow the pattern string; arguments were: &lt;%=args%&gt;.'</span>,
    add_pattern_object_expected: <span class="hljs-string">'Could not add action; unexpected argument; a pattern object or string should be the first argument; arguments were: &lt;%=args%&gt;.'</span>,

    add_action_function_expected: <span class="hljs-string">'Could not add action: the action function should appear after the pattern; arguments were: &lt;%=args%&gt;.'</span>,
    add_action_metadata_not_an_object: <span class="hljs-string">'Could not add action: the argument after the action function should be a metadata object: &lt;%=actmeta%&gt;.'</span>,

    act_if_expects_boolean: <span class="hljs-string">'The method act_if expects a boolean value as its first argument, was: "&lt;%=first%&gt;".'</span>,

    act_not_found: <span class="hljs-string">'No matching action pattern found for "&lt;%=args%&gt;", and no default result provided (using a default$ property).'</span>,
    act_no_args: <span class="hljs-string">'No action pattern defined in "&lt;%=args%&gt;"; the first argument should be a string or object pattern.'</span>
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
